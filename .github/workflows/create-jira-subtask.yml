name: Create Jira Subtask

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  create-jira-subtask:
    runs-on: ubuntu-latest

    steps:
      - name: Extract Jira Story Key
        id: extract-jira-key
        run: |
          STORY_NUMBER=$(echo "${{ github.event.issue.body }}" | grep -oE '[0-9]+' | head -1)
          if [ -z "$STORY_NUMBER" ]; then
            echo "âŒ No story number found"
            exit 1
          fi
          JIRA_KEY="PP-$STORY_NUMBER"
          echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT
          echo "âœ… Built Jira Key: $JIRA_KEY"

      - name: Extract Assignee
        id: extract-assignee
        run: |
          # GitHub ì´ìŠˆì˜ assigneeë¥¼ í™•ì¸
          GITHUB_ASSIGNEE="${{ github.event.issue.assignee.login }}"

          echo "GitHub Assignee: $GITHUB_ASSIGNEE"

          case "$GITHUB_ASSIGNEE" in
            "heeyoung123")
              JIRA_ASSIGNEE="712020:d6d4a8f9-52f7-4976-8b6c-7010ce28c5b5?cloudId=7c421a75-44ad-4581-880c-54ba3c02ebbe"
              ASSIGNEE_NAME="ê¹€í¬ì˜"
              ;;
            *)
              JIRA_ASSIGNEE=""
              ASSIGNEE_NAME=""
              ;;
          esac

          echo "assignee_name=$ASSIGNEE_NAME" >> $GITHUB_OUTPUT
          echo "jira_assignee=$JIRA_ASSIGNEE" >> $GITHUB_OUTPUT
          echo "âœ… GitHub Assignee: $GITHUB_ASSIGNEE -> Jira: $JIRA_ASSIGNEE ($ASSIGNEE_NAME)"

      - name: Extract Issue Description
        id: extract-description
        run: |
          echo "=== Debugging Issue Body ==="
          echo "${{ github.event.issue.body }}"
          echo "============================"

          FULL_BODY="${{ github.event.issue.body }}"

          # "### ì‘ì—… ì„¤ëª…" ë‹¤ìŒë¶€í„° ëê¹Œì§€ ì¶”ì¶œ (ì¤„ë°”ê¿ˆ ìœ ì§€)
          DESCRIPTION=$(echo "$FULL_BODY" | awk '
            BEGIN { found=0; content="" }
            /^### ì‘ì—… ì„¤ëª…/ { found=1; next }
            found && /^###/ { found=0 }
            found { 
              if (content != "") content = content "\n"
              content = content $0 
            }
            END { print content }
          ')

          # ë¹ˆ ê°’ ì²˜ë¦¬
          if [ -z "$DESCRIPTION" ] || [ "$DESCRIPTION" = " " ]; then
            DESCRIPTION="ì‘ì—… ë‚´ìš©ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi

          # GitHub Actions outputì— ì•ˆì „í•˜ê²Œ ì €ì¥ (ì¤„ë°”ê¿ˆ ìœ ì§€)
          {
            echo "description<<EOF"
            echo "$DESCRIPTION"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          echo "âœ… Final Description with line breaks:"
          echo "$DESCRIPTION"

      - name: Create Jira Subtask
        id: create-subtask
        run: |
          echo "Creating Jira Sub-task for story: ${{ steps.extract-jira-key.outputs.jira_key }}"
          echo "Assignee: ${{ steps.extract-assignee.outputs.jira_assignee }}"
          echo "Description: ${{ steps.extract-description.outputs.description }}"

          # ì„¤ëª…ì„ ADF í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ê°œí–‰ ìœ ì§€)
          DESCRIPTION="${{ steps.extract-description.outputs.description }}"

          # ì¤„ë°”ê¿ˆì„ ê¸°ì¤€ìœ¼ë¡œ ê° ì¤„ì„ ë³„ë„ì˜ paragraphë¡œ ë§Œë“¤ê¸°
          ADF_CONTENT=""
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              if [ -n "$ADF_CONTENT" ]; then
                ADF_CONTENT="$ADF_CONTENT,"
              fi
              # JSON ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
              ESCAPED_LINE=$(echo "$line" | sed 's/"/\\"/g' | sed 's/\\/\\\\/g')
              ADF_CONTENT="$ADF_CONTENT{\"type\":\"paragraph\",\"content\":[{\"type\":\"text\",\"text\":\"$ESCAPED_LINE\"}]}"
            fi
          done <<< "$DESCRIPTION"

          # ê¸°ë³¸ í˜ì´ë¡œë“œ ìƒì„± (ADF í˜•ì‹)
          PAYLOAD=$(jq -n \
            --arg project "PP" \
            --arg parent "${{ steps.extract-jira-key.outputs.jira_key }}" \
            --arg summary "${{ github.event.issue.title }}" \
            --argjson content "[$ADF_CONTENT]" \
            '{
              "fields": {
                "project": {"key": $project},
                "parent": {"key": $parent},
                "summary": $summary,
                "description": {
                  "type": "doc",
                  "version": 1,
                  "content": $content
                },
                "issuetype": {"name": "í•˜ìœ„ ì‘ì—…"}
              }
            }')

          # ë‹´ë‹¹ìê°€ ìˆìœ¼ë©´ ì¶”ê°€
          if [ -n "${{ steps.extract-assignee.outputs.jira_assignee }}" ]; then
            PAYLOAD=$(echo "$PAYLOAD" | jq \
              --arg assignee "${{ steps.extract-assignee.outputs.jira_assignee }}" \
              '.fields.assignee = {"accountId": $assignee}')
            echo "âœ… Added assignee to payload"
          fi

          echo "Sending payload:"
          echo "$PAYLOAD"

          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            -H "Authorization: Basic ${{ secrets.JIRA_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d "$PAYLOAD" \
            ${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue)

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')

          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $RESPONSE_BODY"

          if [ "$HTTP_CODE" = "201" ]; then
            JIRA_ISSUE_KEY=$(echo "$RESPONSE_BODY" | jq -r '.key')
            echo "âœ… Created Jira Sub-task: $JIRA_ISSUE_KEY"
            echo "jira_issue_key=$JIRA_ISSUE_KEY" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to create Jira Sub-task: $RESPONSE_BODY"
            exit 1
          fi

      - name: Add Success Comment
        if: steps.create-subtask.outputs.jira_issue_key
        uses: actions/github-script@v7
        with:
          script: |
            const jiraIssueKey = '${{ steps.create-subtask.outputs.jira_issue_key }}';
            const parentStory = '${{ steps.extract-jira-key.outputs.jira_key }}';
            const jiraBaseUrl = '${{ secrets.JIRA_BASE_URL }}';
            const assigneeName = '${{ steps.extract-assignee.outputs.assignee_name }}';

            let assigneeText = '';
            if (assigneeName) {
              assigneeText = `\n**ë‹´ë‹¹ì:** ${assigneeName}`;
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ”— **Jira í•˜ìœ„ ì‘ì—… ìƒì„± ì™„ë£Œ**

            **í•˜ìœ„ ì‘ì—…:** [${jiraIssueKey}](${jiraBaseUrl}/browse/${jiraIssueKey})
            **ìƒìœ„ ìŠ¤í† ë¦¬:** [${parentStory}](${jiraBaseUrl}/browse/${parentStory})${assigneeText}

            > GitHub ì´ìŠˆì™€ Jira í•˜ìœ„ ì‘ì—…ì´ ìë™ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.`
            });
